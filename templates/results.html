{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- Header -->
        <div class="text-center mb-5">
            <div class="feature-icon mx-auto mb-4">
                <i class="fas fa-check-circle"></i>
            </div>
            <h1 class="display-5 fw-bold gradient-text mb-3">Marksheet Verification Complete</h1>
            <p class="text-muted lead">
                Comprehensive analysis of your academic marksheet
            </p>
        </div>

        <!-- Marksheet Actions -->
        <div class="marksheet-actions">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-2">
                        <i class="fas fa-file-pdf text-danger me-2"></i>
                        {{ filename }}
                    </h4>
                    <p class="text-muted mb-0">
                        <i class="fas fa-user-graduate me-2"></i>
                        {{ student_type }} â€¢ {{ total_courses }} Courses Processed
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    {% if pdf_url %}
                    <button onclick="printMarksheet('{{ pdf_url }}')" class="btn btn-success btn-lg">
                        <i class="fas fa-print me-2"></i>Print Marksheet
                    </button>
                    {% else %}
                    <span class="text-muted">PDF not available</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Student Type Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body text-center py-4">
                <h4 class="mb-3 fw-semibold">Student Information</h4>
                <span class="badge bg-primary fs-5 p-3 mb-3">
                    <i class="fas fa-user-graduate me-2"></i>
                    {{ student_type }}
                </span>
                <p class="text-muted mb-0">
                    <i class="fas fa-file-pdf me-2"></i>
                    File: {{ filename }}
                </p>
            </div>
        </div>

        <!-- Status Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body text-center py-4">
                <h4 class="mb-3 fw-semibold">
                    Verification Status
                </h4>
                <span class="badge {% if verification.egp.match and verification.credits.match and verification.sgpa.match %}status-verified{% else %}status-mismatch{% endif %} fs-5 p-3">
                    <i class="fas fa-{{ 'check' if verification.egp.match and verification.credits.match and verification.sgpa.match else 'exclamation' }}-circle me-2"></i>
                    {{ 'All Values Verified' if verification.egp.match and verification.credits.match and verification.sgpa.match else 'Verification Failed' }}
                </span>
                <p class="text-muted mt-3 mb-0">
                    <i class="fas fa-book me-2"></i>
                    {{ total_courses }} courses processed
                </p>
            </div>
        </div>

        <!-- Results Grid -->
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card verification-card border-0 shadow-sm h-100">
                    <div class="card-body text-center p-4">
                        <i class="fas fa-calculator fa-3x mb-3 text-primary"></i>
                        <h5 class="fw-semibold mb-3">EGP</h5>
                        <h2 class="{{ 'text-success' if verification.egp.match else 'text-danger' }} fw-bold mb-3">
                            {{ "%.1f"|format(verification.egp.calculated) }}
                        </h2>
                        <p class="text-muted mb-2">Reported: {{ "%.1f"|format(verification.egp.reported) }}</p>
                        <div class="mt-3">
                            <span class="badge {% if verification.egp.match %}status-verified{% else %}status-mismatch{% endif %}">
                                <i class="fas fa-{{ 'check' if verification.egp.match else 'times' }}-circle me-1"></i>
                                {{ 'Verified' if verification.egp.match else 'Mismatch' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card verification-card border-0 shadow-sm h-100">
                    <div class="card-body text-center p-4">
                        <i class="fas fa-weight-hanging fa-3x mb-3 text-primary"></i>
                        <h5 class="fw-semibold mb-3">Credits</h5>
                        <h2 class="{{ 'text-success' if verification.credits.match else 'text-danger' }} fw-bold mb-3">
                            {{ "%.1f"|format(verification.credits.calculated) }}
                        </h2>
                        <p class="text-muted mb-2">Reported: {{ "%.1f"|format(verification.credits.reported) }}</p>
                        <div class="mt-3">
                            <span class="badge {% if verification.credits.match %}status-verified{% else %}status-mismatch{% endif %}">
                                <i class="fas fa-{{ 'check' if verification.credits.match else 'times' }}-circle me-1"></i>
                                {{ 'Verified' if verification.credits.match else 'Mismatch' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card verification-card border-0 shadow-sm h-100">
                    <div class="card-body text-center p-4">
                        <i class="fas fa-percentage fa-3x mb-3 text-primary"></i>
                        <h5 class="fw-semibold mb-3">SGPA</h5>
                        <h2 class="{{ 'text-success' if verification.sgpa.match else 'text-danger' }} fw-bold mb-3">
                            {{ "%.2f"|format(verification.sgpa.calculated) }}
                        </h2>
                        <p class="text-muted mb-2">Reported: {{ "%.2f"|format(verification.sgpa.reported) }}</p>
                        <div class="mt-3">
                            <span class="badge {% if verification.sgpa.match %}status-verified{% else %}status-mismatch{% endif %}">
                                <i class="fas fa-{{ 'check' if verification.sgpa.match else 'times' }}-circle me-1"></i>
                                {{ 'Verified' if verification.sgpa.match else 'Mismatch' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Courses Table -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-semibold">
                        <i class="fas fa-list me-2"></i>Course Analysis
                    </h5>
                    <span class="badge bg-light text-primary fs-6">
                        {{ courses|length }} Courses
                    </span>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                {% if courses and courses[0].get('semester') %}
                                <th class="ps-4 fw-semibold">Semester</th>
                                {% endif %}
                                <th class="fw-semibold">Course Code</th>
                                <th class="fw-semibold">Credit</th>
                                <th class="fw-semibold">Earned</th>
                                <th class="fw-semibold">Grade</th>
                                <th class="fw-semibold">Point</th>
                                <th class="fw-semibold">Contribution</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for course in courses %}
                            <tr>
                                {% if course.get('semester') %}
                                <td class="ps-4 fw-semibold">{{ course.semester }}</td>
                                {% endif %}
                                <td class="fw-semibold text-primary">{{ course.course_code }}</td>
                                <td>{{ course.credit }}</td>
                                <td>{{ course.earned }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ course.grade }}</span>
                                </td>
                                <td>
                                    {% set grade_points = {'A+': 10, 'A': 9, 'B+': 8, 'B': 7, 'C+': 6, 'C': 5, 'D': 4, 'F': 0, 'FF': 0, 'P': 5, 'PP': 5, 'PASS': 5, 'COMP': 5} %}
                                    {% set grade_point = grade_points.get(course.grade.upper(), 0) %}
                                    <span class="fw-bold text-dark">{{ grade_point }}</span>
                                </td>
                                <td>
                                    <span class="fw-bold text-success">{{ (course.earned * grade_point)|int }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-active fw-bold">
                            <tr>
                                {% if courses and courses[0].get('semester') %}
                                <td class="ps-4">Total</td>
                                {% endif %}
                                <td>Total</td>
                                <td>{{ courses|sum(attribute='credit') }}</td>
                                <td>{{ "%.1f"|format(verification.credits.calculated) }}</td>
                                <td></td>
                                <td></td>
                                <td class="text-success">{{ "%.1f"|format(verification.egp.calculated) }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="text-center mt-5">
    <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg me-3 px-4">
        <i class="fas fa-plus-circle me-2"></i>Verify Another
    </a>
    {% if pdf_url %}
    <button onclick="printMarksheet('{{ pdf_url }}')" class="btn btn-success btn-lg px-4">
        <i class="fas fa-print me-2"></i>Print Marksheet
    </button>
    {% endif %}
</div>

<script>
    function printMarksheet(pdfUrl) {
    if (pdfUrl) {
        // Method 1: Direct print using iframe
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = pdfUrl;
        document.body.appendChild(iframe);
        
        iframe.onload = function() {
            try {
                // Wait a bit for PDF to fully render
                setTimeout(() => {
                    iframe.contentWindow.focus();
                    
                    // Add event listeners for print dialog
                    iframe.contentWindow.addEventListener('afterprint', function() {
                        // Clean up after printing is done
                        setTimeout(() => {
                            if (document.body.contains(iframe)) {
                                document.body.removeChild(iframe);
                            }
                        }, 1000);
                    });
                    
                    // Trigger print
                    iframe.contentWindow.print();
                    
                }, 1000); // Wait 1 second for PDF to render
            } catch (error) {
                // Clean up and try fallback
                if (document.body.contains(iframe)) {
                    document.body.removeChild(iframe);
                }
                fallbackPrint(pdfUrl);
            }
        };
        
        iframe.onerror = function() {
            if (document.body.contains(iframe)) {
                document.body.removeChild(iframe);
            }
            fallbackPrint(pdfUrl);
        };
        
        // Set timeout for iframe loading
        setTimeout(() => {
            if (document.body.contains(iframe) && (!iframe.contentWindow || iframe.contentWindow.document.readyState !== 'complete')) {
                if (document.body.contains(iframe)) {
                    document.body.removeChild(iframe);
                }
                fallbackPrint(pdfUrl);
            }
        }, 15000); // 15 second timeout
        
    } else {
        alert('PDF not available for printing.');
    }
}

function fallbackPrint(pdfUrl) {
    // Method 2: Download first, then print
    const downloadLink = document.createElement('a');
    downloadLink.href = pdfUrl;
    downloadLink.download = 'marksheet.pdf';
    downloadLink.target = '_blank';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
    
    // Inform user to print the downloaded file
    setTimeout(() => {
        const userChoice = confirm(
            'The marksheet has been opened in a new tab or downloaded.\n\n' +
            'Please use the print function in your PDF viewer (Ctrl+P) to print the marksheet.\n\n' +
            'Click OK to continue.'
        );
    }, 1000);
}
</script>
{% endblock %}